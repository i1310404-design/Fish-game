<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é‡£é­šæ¨¡æ“¬å™¨ V15 - å°æŒ‰éˆ•ç‰ˆï¼ˆä¿ç•™åŸå§‹åŠŸèƒ½ï¼‰</title>
  <style>
    /* åŸºæœ¬é é¢ */
    :root {
      --panel-bg: rgba(255,255,255,0.95);
      --accent: #1976D2;
    }
    *{box-sizing:border-box}
    body { margin:0; font-family:"Segoe UI",system-ui,-apple-system,"Helvetica Neue",Arial; background:linear-gradient(to bottom,#87CEEB 60%,#1E90FF 100%); color:#111; -webkit-tap-highlight-color: transparent; }
    #game { display:flex; height:100vh; align-items:stretch; position:relative; }

    /* å·¦å´å•†åº—åˆ—ï¼ˆä¿ç•™ï¼‰ */
    #shop-panel { width:60px; background:#ffffffcc; display:flex; flex-direction:column; align-items:center; padding-top:10px; box-shadow:2px 0 5px rgba(0,0,0,0.15); position:relative; z-index:20;}
    #shop-panel button { font-size:24px; background:none; border:none; cursor:pointer; padding:6px; }
    #shop-panel .lock-badge { position:absolute; top:4px; right:6px; font-size:12px; color:#c62828; display:none; }

    /* ç©å®¶è³‡è¨Š */
    #player-info-container { position:absolute; top:12px; left:80px; color:#fff; text-shadow:1px 1px 3px rgba(0,0,0,0.6); font-weight:700; z-index:30; }
    #player-name { font-size:15px; margin-bottom:6px; }
    #level-bar-container { width:180px; height:12px; background:rgba(255,255,255,0.28); border-radius:10px; overflow:hidden; box-shadow:inset 0 0 4px rgba(0,0,0,0.2); }
    #level-bar { height:100%; width:0%; background:linear-gradient(90deg,#ffd700,#ffa500); transition:width .4s ease; }

    /* ä¸»ç•«é¢ */
    #main-panel { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; padding-bottom:120px; }
    #scoreboard { position:absolute; top:12px; right:12px; background:var(--panel-bg); padding:10px 14px; border-radius:12px; font-weight:800; display:flex; flex-direction:column; align-items:flex-end; gap:6px; box-shadow:0 6px 18px rgba(0,0,0,0.12); z-index:30;}
    #rod-info { position:absolute; top:72px; left:80px; background:rgba(255,255,255,0.12); padding:6px 12px; border-radius:10px; font-size:14px; z-index:30; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.45); }

    /* SVG é‡£ç«¿æ¨¡å‹ï¼ˆä¸Šæ–¹ï¼‰ */
    #rod-svg-wrap { position:absolute; left:12%; top:6%; width:50vw; height:36vh; pointer-events:none; z-index:6; opacity:0.98; }
    #rod-svg { width:100%; height:100%; display:block; }
    .rod-handle { fill:#5d4037; }
    .rod-body { stroke:#2e7d32; stroke-width:6; fill:none; stroke-linecap:round; stroke-linejoin:round; }
    .rod-reel { fill:#9e9e9e; stroke:#616161; stroke-width:2; }

    /* é‡£é­šæ–‡å­—/åœ–ç¤º */
    #result { font-size:20px; margin-top:10px; text-shadow:1px 1px 2px #000; color:#fff; text-align:center; z-index:30; }
    /* fish-name-badge: name area colored by rank (background color, not border) */
    .fish-name-badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:10px;
      color: #111;
      font-weight:900;
      box-shadow: 0 6px 20px rgba(0,0,0,0.18);
      min-width:160px;
      text-align:center;
      background: rgba(255,255,255,0.9); /* will be overridden by rank class */
      transition: transform .18s ease;
      font-size:16px;
    }
    #fish-level { font-size:18px; margin-top:10px; font-weight:700; color:#fff; text-shadow:1px 1px 2px #000; z-index:30; }
    #fish-icon { font-size:56px; margin-top:6px; z-index:30; transition: transform .45s cubic-bezier(.2,.8,.2,1); }

    /* AFK çµæœè¦–çª—ï¼ˆç½®ä¸­å½ˆçª—ï¼‰ */
    #afk-results { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); display:none; width:88vw; max-width:760px; max-height:72vh; background:var(--panel-bg); border-radius:14px; padding:14px; box-shadow:0 12px 40px rgba(0,0,0,0.25); z-index:10050; overflow:auto; }
    #afk-fish-container { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }
    .afk-fish { width:70px; height:70px; border-radius:12px; border:3px solid; display:flex; align-items:center; justify-content:center; font-size:36px; position:relative; }
    .afk-count { position:absolute; bottom:4px; right:6px; font-size:16px; font-weight:800; background:rgba(0,0,0,0.6); color:white; padding:2px 6px; border-radius:8px; }
    #afk-coin-display { width:100%; text-align:center; margin-top:10px; font-weight:800; font-size:18px; padding:8px; border-radius:10px; border:2px solid #2196F3; display:flex; justify-content:center; align-items:center; gap:8px; }
    #afk-powder-display { width:100%; text-align:center; margin-top:8px; font-weight:800; font-size:16px; display:flex; justify-content:center; align-items:center; gap:8px; }

    /* å°æŒ‰éˆ•åˆ—ï¼ˆä¸Šç§»ç‰ˆï¼‰ */
    .small-button-row {
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:100px; /* æŠŠæŒ‰éˆ•å¾€ä¸Šç§»ï¼Œé¿å…èˆ‡åº•éƒ¨é•·æ¬„é‡ç–Š */
      display:flex;
      gap:10px;
      z-index:9999;
      align-items:center;
    }
    .btn-small {
      min-width:110px;
      padding:10px 12px;
      border-radius:12px;
      border:none;
      font-weight:800;
      font-size:15px;
      cursor:pointer;
      box-shadow:0 8px 26px rgba(0,0,0,0.12);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background:var(--accent);
      color:white;
    }
    .btn-small.secondary { background:#4CAF50; }
    .btn-small.tertiary { background:#FF9800; color:#111; }

    .btn-small:disabled { opacity:0.5; cursor:not-allowed; box-shadow:none; }

    /* åº•éƒ¨çª„é•·æ¬„ï¼ˆå·¦å´ç‚ºé‡£ç«¿å€ï¼Œå³å´ç‚ºå¿«æ·è³‡è¨Šï¼‰ */
    .bottom-bar {
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:12px;
      width:94%;
      max-width:920px;
      height:72px;
      background:var(--panel-bg);
      border-radius:12px;
      display:flex;
      align-items:center;
      box-shadow:0 8px 26px rgba(0,0,0,0.12);
      padding:8px 12px;
      gap:12px;
      z-index:9990;
    }
    .bottom-rod {
      width:220px;
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px;
      border-radius:10px;
      border-right:1px solid rgba(0,0,0,0.06);
    }
    .rod-preview-small {
      width:64px; height:44px; border-radius:8px; background:linear-gradient(180deg,#fff,#f5f5f5); display:flex; align-items:center; justify-content:center; font-size:22px;
      box-shadow:inset 0 -6px 12px rgba(0,0,0,0.04);
    }
    .rod-name-small { font-weight:800; font-size:14px; color:#222; }

    .bottom-right {
      flex:1; display:flex; align-items:center; justify-content:flex-end; gap:10px;
    }
    .bottom-info { font-weight:700; color:#333; margin-right:8px; display:flex; align-items:center; gap:6px; }

    /* å•†åº—æµ®å±¤ */
    #shop { position:fixed; left:70px; top:80px; width:360px; background:var(--panel-bg); padding:12px; border-radius:12px; display:none; box-shadow:0 12px 40px rgba(0,0,0,0.2); z-index:20000; max-height:70vh; overflow:auto; }

    .shop-item { padding:8px; background:#eaf6ff; border-radius:8px; margin:8px 0; display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:800; }
    .shop-btn.buy { background:#4CAF50; color:#fff; border:none; padding:6px 10px; border-radius:8px; font-weight:900; cursor:pointer; }
    .shop-btn.owned { background:#9e9e9e; color:#fff; padding:6px 10px; border-radius:8px; border:none; cursor:default; }

    /* modal é‡£ç«¿ä»‹é¢ï¼ˆç½®ä¸­ï¼‰ */
    #rod-modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.98); background:var(--panel-bg); border-radius:12px; padding:12px; box-shadow:0 20px 60px rgba(0,0,0,0.25); z-index:30000; display:none; width:86vw; max-width:720px; max-height:78vh; overflow:auto; }
    #rod-modal.show { display:block; transform:translate(-50%,-50%) scale(1); }
    .rod-row { display:flex; align-items:center; justify-content:space-between; padding:8px; background:#fff; border-radius:10px; margin-bottom:8px; gap:8px; }
    .modal-equip-btn { border:none; padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer; }
    .modal-equip-btn.equip { background:#1976D2; color:white; }
    .modal-equip-btn.disabled { background:#9e9e9e; color:white; cursor:not-allowed; }

    /* æ–°å¢ï¼šrod-modal preview å€ */
    #rod-modal-preview {
      width:100%;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:flex-start;
      padding:8px 0 12px 0;
      border-bottom:1px solid rgba(0,0,0,0.06);
      margin-bottom:12px;
    }
    #rod-preview-big {
      width:240px;
      height:120px;
      border-radius:10px;
      background:linear-gradient(180deg,#fff,#f8fbff);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
      flex-shrink:0;
    }
    #rod-preview-info { display:flex; flex-direction:column; gap:6px; }
    #rod-list { display:flex; flex-direction:column; gap:8px; max-height:44vh; overflow:auto; padding-right:6px; }

    /* å°æç¤ºèˆ‡å‹•ç•« */
    #level-up-notice { position:fixed; left:50%; top:18%; transform:translateX(-50%); display:none; background:linear-gradient(90deg,#ffd54f,#ffb300); padding:10px 16px; border-radius:12px; box-shadow:0 8px 26px rgba(0,0,0,0.18); font-weight:900; z-index:40000; }
    #unlock-notice { position:fixed; left:50%; top:28%; transform:translate(-50%,-50%); display:none; background:linear-gradient(90deg,#64b5f6,#42a5f5); color:white; padding:12px 16px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.24); z-index:40050; font-weight:900; }

    /* é‡£é­š/æµ®æ¨™å‹•ç•«è¼”åŠ©ï¼ˆJS æœƒæ”¹è®Š transform / dï¼‰ */
    .fish-pop {
      animation: popIn .45s cubic-bezier(.2,.9,.2,1);
    }
    @keyframes popIn {
      0%{ transform:scale(.2) translateY(6px); opacity:0; }
      60%{ transform:scale(1.08) translateY(-6px); opacity:1; }
      100%{ transform:scale(1) translateY(0); opacity:1; }
    }

    /* rank color classes for name background (æ”¹ç‚ºèƒŒæ™¯è‰²) */
    .rank-D { background:#BDBDBD; color:#111; } /* grey */
    .rank-C { background:#A5D6A7; color:#111; } /* light green */
    .rank-B { background:#90CAF9; color:#111; } /* light blue */
    .rank-A { background:#CE93D8; color:#111; } /* light purple */
    .rank-S { background:#FFD54F; color:#111; } /* gold */

    /* responsive */
    @media (max-width:520px){
      #rod-svg-wrap { left:6%; width:80vw; height:30vh; top:4%; }
      .small-button-row { bottom:120px; gap:6px; }
      .btn-small { min-width:88px; padding:8px 10px; font-size:13px; }
      .bottom-bar { height:84px; padding:10px; }
      #rod-preview-big { width:180px; height:96px; }
    }

    /* ç²‰æœ«åœ–ç‰‡å°èª¿æ•´ */
    .powder-img { width:20px; height:20px; vertical-align:middle; }
    .powder-big { width:28px; height:28px; vertical-align:middle; }
  </style>
</head>
<body>
  <div id="game">
    <!-- å·¦å´å•†åº—æŒ‰éˆ• -->
    <div id="shop-panel">
      <button id="shop-btn" aria-label="å•†åº—">ğŸ›’</button>
      <span class="lock-badge" id="shop-lock" style="display:none">ğŸ”’</span>
    </div>

    <!-- ç©å®¶è³‡è¨Š -->
    <div id="player-info-container">
      <div id="player-name">ç©å®¶ï¼š<span id="name-display">æœªçŸ¥</span></div>
      <div id="level-bar-container"><div id="level-bar"></div></div>
    </div>

    <!-- ä¸»é¢æ¿ -->
    <div id="main-panel">
      <div id="scoreboard">ğŸª™ <span id="coin-display">0</span><br/>åˆ†æ•¸ï¼š<span id="score-display">0</span></div>
      <div id="rod-info">ç•¶å‰é‡£ç«¿ï¼šæ™®é€šé‡£ç«¿</div>

      <!-- ä¿ç•™ç·šèˆ‡æµ®æ¨™ç¯€é»ï¼ˆåŸå§‹çµæ§‹ï¼Œå¯èƒ½éš±è—ï¼‰ -->
      <div id="rod-line" style="display:none"></div>
      <div id="bobber" style="display:none"></div>

      <!-- SVG é‡£ç«¿å»ºæ¨¡ï¼ˆä¸Šæ–¹å±•ç¤ºï¼‰ -->
      <div id="rod-svg-wrap">
        <svg id="rod-svg" viewBox="0 0 600 400" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
          <rect id="rod-handle" class="rod-handle" x="70" y="250" width="80" height="16" rx="8"></rect>
          <circle id="rod-reel" class="rod-reel" cx="120" cy="258" r="18"></circle>
          <path id="rod-body" class="rod-body" d="M150,258 C260,210 380,180 520,150"></path>
          <path id="rod-line-svg" class="rod-body" d="M520,150 Q540,200 560,240" stroke="#2e7d32" fill="none"></path>
          <circle id="bobber-svg" class="rod-reel" cx="560" cy="240" r="10"></circle>
        </svg>
      </div>

      <!-- ä¸­å¤®é¡¯ç¤ºé‡£é­šçµæœ -->
      <div id="fish-level"></div>
      <div id="result">é»æ“Šã€Œé‡£é­šï¼ã€é–‹å§‹</div>
      <div id="fish-icon" aria-hidden="true"></div>

      <!-- AFK çµæœå½ˆçª— -->
      <div id="afk-results" role="dialog" aria-hidden="true">
        <div id="afk-fish-container"></div>
        <div id="afk-coin-display">é‡‘å¹£ï¼š0</div>
        <div id="afk-powder-display" style="display:none;"><img id="afk-powder-img" class="powder-big" src="" alt="powder"> ç²‰æœ«ï¼š<span id="afk-powder-count">0</span></div>
        <div style="display:flex; gap:10px; margin-top:12px; justify-content:center;">
          <button id="quick-patrol-claim-btn" class="btn-small secondary" style="min-width:150px;">é ˜å–å¿«é€Ÿå·¡é‚çå‹µ</button>
          <button id="afk-claim-btn" class="btn-small tertiary" style="min-width:150px;">é ˜å–æ›æ©Ÿçå‹µ</button>
        </div>
        <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
          <button id="afk-close-btn" style="background:#f44336;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer;">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å°æŒ‰éˆ•åˆ—ï¼šä¸Šç§»åˆ°åº•æ¬„ä¹‹ä¸Šï¼ˆå°æ¡†ï¼‰ -->
  <div class="small-button-row" role="toolbar" aria-label="éŠæˆ²å¿«æ·éµ">
    <button id="rod-btn" class="btn-small" title="é‡£ç«¿">é‡£ç«¿</button>
    <button id="fish-btn" class="btn-small" title="é‡£é­š">ğŸ£ é‡£é­šï¼</button>
    <button id="afk-btn" class="btn-small secondary" title="æ›æ©Ÿæ”¶ç›Š">ğŸ’¤ æ›æ©Ÿæ”¶ç›Š</button>
  </div>

  <!-- åº•éƒ¨çª„é•·æ¬„ï¼šå·¦å´ç‚ºé‡£ç«¿å€å¡Š -->
  <div class="bottom-bar" role="navigation" aria-label="åº•éƒ¨ç‹€æ…‹åˆ—">
    <div class="bottom-rod" aria-hidden="false">
      <div class="rod-preview-small" id="rod-preview-small">ğŸ£</div>
      <div style="display:flex;flex-direction:column;justify-content:center;">
        <div class="rod-name-small" id="rod-name-small">æ™®é€šé‡£ç«¿</div>
        <div style="font-size:12px;color:#666;">é»é¸å¯åˆ‡æ›</div>
      </div>
    </div>

    <div class="bottom-right">
      <div class="bottom-info">ğŸª™ <span id="coin-display-bottom">0</span></div>
      <div class="bottom-info">åˆ†æ•¸ <span id="score-display-bottom">0</span></div>
      <div class="bottom-info"><img id="powder-icon-bottom" class="powder-img" src="" alt="powder"> ç²‰æœ« <span id="powder-count">0</span></div>
      <button id="open-shop-bottom" class="btn-small" style="min-width:110px;background:#fff;color:var(--accent);border:2px solid var(--accent);">å•†åº—</button>
    </div>
  </div>

  <!-- å•†åº—æµ®å±¤ -->
  <div id="shop" aria-hidden="true"></div>

  <!-- é‡£ç«¿ modalï¼ˆç½®ä¸­ï¼‰ -->
  <div id="rod-modal" role="dialog" aria-hidden="true">
    <!-- preview top -->
    <div id="rod-modal-preview" style="display:none;">
      <div id="rod-preview-big" aria-hidden="true">
        <!-- å¤§é è¦½ SVGï¼ˆç”± JS ç”Ÿæˆå…§å®¹æˆ–è¤‡è£½å° SVGï¼‰ -->
        <svg id="rod-preview-svg" viewBox="0 0 600 200" style="width:220px;height:100%;" preserveAspectRatio="xMidYMid meet"></svg>
      </div>
      <div id="rod-preview-info">
        <div style="font-weight:900;font-size:18px;" id="rod-preview-name">é‡£ç«¿é è¦½</div>
        <div id="rod-preview-desc" style="color:#333">é»æ“Šä¸‹æ–¹ä»»ä¸€é‡£ç«¿å¯åœ¨æ­¤é è¦½ã€‚æ»‘å‹•æ¸…å–®ä»¥æŸ¥çœ‹æ›´å¤šé‡£ç«¿ã€‚</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div style="font-weight:900;font-size:18px;">åˆ‡æ›é‡£ç«¿</div>
      <div>
        <button id="rod-modal-close" style="border:none;background:none;font-size:20px;cursor:pointer;">âœ•</button>
      </div>
    </div>
    <div id="rod-list"></div>
  </div>

  <audio id="sound-fish" src="https://cdn.pixabay.com/audio/2022/03/15/audio_7e3dc19b7e.mp3"></audio>
  <div id="level-up-notice"></div>
  <div id="unlock-notice"></div>

<script>
/* ========= é‚è¼¯èˆ‡è³‡æ–™ - ä¿ç•™åŸæœ‰çš„è¡Œç‚ºèˆ‡ localStorage çµæ§‹ ========= */

/* è¼‰å…¥ä¸¦ä¿ç•™ä½ çš„åŸå§‹è¨­å®šèˆ‡è³‡æ–™éµï¼šscore, coins, rod, name, afkCount, lastAFKTime, ownedRods, fishCaught ç­‰ */
let score = +localStorage.getItem("score") || 0;
let coins = +localStorage.getItem("coins") || 0;
let equippedRod = localStorage.getItem("rod") || "æ™®é€šé‡£ç«¿";
let playerName = localStorage.getItem("name") || prompt("è«‹è¼¸å…¥ç©å®¶åç¨±ï¼š") || "ç©å®¶";
localStorage.setItem("name", playerName);

document.getElementById("name-display").textContent = playerName;

/* ç¶“é©—èˆ‡ç­‰ç´šï¼ˆç°¡åŒ–ï¼‰ */
let experience = +localStorage.getItem("experience") || 0;

/* æ›æ©Ÿè¨ˆæ•¸ */
let afkCount = +localStorage.getItem("afkCount") || 0;
let lastAFKTime = +localStorage.getItem("lastAFKTime") || Date.now();

/* å¿«é€Ÿå·¡é‚æ¯æ—¥æ¬¡æ•¸ */
let lastQuickPatrolClaimDate = localStorage.getItem("lastQuickPatrolClaimDate") || "";
let quickPatrolClaimsToday = +localStorage.getItem("quickPatrolClaimsToday") || 0;

/* æ“æœ‰é‡£ç«¿ */
let ownedRods = JSON.parse(localStorage.getItem("ownedRods") || "null");
if(!ownedRods){ ownedRods = ["æ™®é€šé‡£ç«¿"]; localStorage.setItem("ownedRods", JSON.stringify(ownedRods)); }

/* é‡£ç«¿ç­‰ç´š (rodLevels) ç”¨æ–¼å‡ç´šæ©Ÿåˆ¶ */
let rodLevels = JSON.parse(localStorage.getItem("rodLevels") || "null");
if(!rodLevels){ rodLevels = {}; /* default 0 */ localStorage.setItem("rodLevels", JSON.stringify(rodLevels)); }

/* ç²‰æœ«é“å…· */
let powder = +localStorage.getItem("powder") || 0;

/* å·²é‡£åˆ°çš„é­šæ•¸ */
let fishCaught = +localStorage.getItem("fishCaught") || 0;

const UNLOCK_KEY = "shownUnlocks_v1";
let shownUnlocks = JSON.parse(localStorage.getItem(UNLOCK_KEY) || "{}");

/* ç­‰ç´šè¡¨ */
const levels = [
  { lvl:0, need:0 },
  { lvl:1, need:50 },
  { lvl:2, need:200 },
  { lvl:3, need:450 },
  { lvl:4, need:750 },
  { lvl:5, need:1200 }
];

/* é­šæ¸…å–®ï¼ˆè¼ƒè±å¯Œï¼‰ */
const fishList = [
 {name:"ç©ºæ°£",score:0,icon:"â„ï¸",coinMin:0,coinMax:2, rank:"D", imgKey:"â„ï¸"},
 {name:"æ²™ä¸é­š",score:1,icon:"ğŸŸ",coinMin:1,coinMax:8, rank:"D", imgKey:"ğŸŸ"},
 {name:"æµ·æ˜Ÿ",score:1,icon:"â­",coinMin:1,coinMax:6, rank:"D", imgKey:"â­"},
 {name:"é­·é­š",score:3,icon:"ğŸ¦‘",coinMin:5,coinMax:25, rank:"C", imgKey:"ğŸ¦‘"},
 {name:"èƒèŸ¹",score:2,icon:"ğŸ¦€",coinMin:3,coinMax:14, rank:"C", imgKey:"ğŸ¦€"},
 {name:"å°ä¸‘é­š",score:4,icon:"ğŸ ",coinMin:8,coinMax:22, rank:"B", imgKey:"ğŸ "},
 {name:"æ²³è±š",score:5,icon:"ğŸ¡",coinMin:18,coinMax:45, rank:"B", imgKey:"ğŸ¡"},
 {name:"è¦",score:2,icon:"ğŸ¦",coinMin:2,coinMax:12, rank:"C", imgKey:"ğŸ¦"},
 {name:"æ°´æ¯",score:3,icon:"ğŸª¼",coinMin:4,coinMax:18, rank:"C", imgKey:"ğŸª¼"},
 {name:"ç« é­š",score:8,icon:"ğŸ™",coinMin:25,coinMax:70, rank:"A", imgKey:"ğŸ™"},
 {name:"é¯¨é­š",score:35,icon:"ğŸ‹",coinMin:100,coinMax:250, rank:"S", imgKey:"ğŸ‹"},
 {name:"æµ·é¾œ",score:20,icon:"ğŸ¢",coinMin:60,coinMax:140, rank:"S", imgKey:"ğŸ¢"},
 {name:"é¯Šé­š",score:10,icon:"ğŸ¦ˆ",coinMin:30,coinMax:75, rank:"B", imgKey:"ğŸ¦ˆ"},
 {name:"é°»é­š",score:9,icon:"ğŸ",coinMin:30,coinMax:80, rank:"A", imgKey:"ğŸ"},
 {name:"é‡‘æ§é­š",score:12,icon:"ğŸŸâ€ğŸ¦±",coinMin:35,coinMax:95, rank:"A", imgKey:"ğŸŸâ€ğŸ¦±"},
 {name:"é‡‘é¾é­š",score:25,icon:"ğŸ²",coinMin:45,coinMax:140, rank:"S", imgKey:"ğŸ²"},
 {name:"ç¥ç§˜é¾é­š",score:30,icon:"ğŸ‰",coinMin:50,coinMax:160, rank:"S", imgKey:"ğŸ‰"},
 {name:"å½©è™¹é­š",score:22,icon:"ğŸŒˆ",coinMin:60,coinMax:150, rank:"S", imgKey:"ğŸŒˆ"},
 {name:"æ·±æµ·å·¨ç¸",score:40,icon:"ğŸ‘¾",coinMin:180,coinMax:400, rank:"S", imgKey:"ğŸ‘¾"},
 {name:"æˆ°ç¥é­š",score:50,icon:"âš”ï¸",coinMin:250,coinMax:600, rank:"S", imgKey:"âš”ï¸"},
];

/* é‡£ç«¿ -> åŸºç¤ rank æ©Ÿç‡åˆ†é…ï¼ˆD,C,B,A,Sï¼‰*/
const baseRankProbsByRod = {
  "æ™®é€šé‡£ç«¿": { D:0.60, C:0.25, B:0.10, A:0.04, S:0.01 },
  "ç²¾è‰¯é‡£ç«¿": { D:0.45, C:0.30, B:0.12, A:0.08, S:0.05 },
  "ç¨€æœ‰é‡£ç«¿": { D:0.35, C:0.28, B:0.18, A:0.12, S:0.07 },
  "å²è©©é‡£ç«¿": { D:0.28, C:0.26, B:0.20, A:0.16, S:0.10 },
  "å‚³èªªé‡£ç«¿": { D:0.18, C:0.22, B:0.22, A:0.20, S:0.18 }
};

const rodPrices = {"ç²¾è‰¯é‡£ç«¿":500,"ç¨€æœ‰é‡£ç«¿":1000,"å²è©©é‡£ç«¿":2000,"å‚³èªªé‡£ç«¿":3500};

const rarityColors = {
  "æ™®é€šé‡£ç«¿": { stroke: "#5d4037", handle: "#5d4037" },
  "ç²¾è‰¯é‡£ç«¿": { stroke: "#2e7d32", handle: "#2e7d32" },
  "ç¨€æœ‰é‡£ç«¿": { stroke: "#1565c0", handle: "#1565c0" },
  "å²è©©é‡£ç«¿": { stroke: "#6a1b9a", handle: "#6a1b9a" },
  "å‚³èªªé‡£ç«¿": { stroke: "#d4af37", handle: "#d4af37" }
};

/* DOM å¿«å– */
const scoreD = document.getElementById("score-display"),
      coinD = document.getElementById("coin-display"),
      scoreD2 = document.getElementById("score-display-bottom"),
      coinD2 = document.getElementById("coin-display-bottom"),
      rodInfo = document.getElementById("rod-info"),
      result = document.getElementById("result"),
      fishIcon = document.getElementById("fish-icon"),
      fishLevel = document.getElementById("fish-level"),
      afkResults = document.getElementById("afk-results"),
      afkFishContainer = document.getElementById("afk-fish-container"),
      afkCoinD = document.getElementById("afk-coin-display"),
      afkPowderDisplay = document.getElementById("afk-powder-display"),
      afkPowderCount = document.getElementById("afk-powder-count"),
      shop = document.getElementById("shop"),
      fishBtn = document.getElementById("fish-btn"),
      afkBtn = document.getElementById("afk-btn"),
      rodBtn = document.getElementById("rod-btn"),
      rodPreviewSmall = document.getElementById("rod-preview-small"),
      rodNameSmall = document.getElementById("rod-name-small"),
      rodListDiv = document.getElementById("rod-list"),
      openShopBottom = document.getElementById("open-shop-bottom"),
      quickPatrolClaimBtn = document.getElementById("quick-patrol-claim-btn"),
      afkClaimBtn = document.getElementById("afk-claim-btn"),
      afkCloseBtn = document.getElementById("afk-close-btn"),
      shopBtn = document.getElementById("shop-btn"),
      shopLock = document.getElementById("shop-lock"),
      powderCountSpan = document.getElementById("powder-count"),
      powderIconBottom = document.getElementById("powder-icon-bottom"),
      afkPowderImg = document.getElementById("afk-powder-img");

const rodLineSVG = document.getElementById("rod-line-svg");
const bobberSVG = document.getElementById("bobber-svg");
const rodBody = document.getElementById("rod-body");
const rodHandle = document.getElementById("rod-handle");
const rodReel = document.getElementById("rod-reel");

/* rank -> class mapping for name badge */
const rankClass = { "D":"rank-D", "C":"rank-C", "B":"rank-B", "A":"rank-A", "S":"rank-S" };

/* å…§åµŒç²‰æœ« SVG åœ–ç¤º data URLï¼ˆå¯è‡ªè¡Œæ›¿æ›æˆå¤–éƒ¨åœ–ç‰‡ URLï¼‰ */
const POWDER_SVG = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g><path fill='#F9A825' d='M32 4c-2.2 0-4 1.8-4 4 0 1.2.6 2.2 1.5 2.9-2.9 1.4-5 4.2-5 7.4 0 4.7 3.8 8.5 8.5 8.5s8.5-3.8 8.5-8.5c0-3.2-2.1-6-5-7.4.9-.7 1.5-1.7 1.5-2.9 0-2.2-1.8-4-4-4z'/><circle fill='#FFF59D' cx='24' cy='36' r='3'/><circle fill='#FFF59D' cx='40' cy='32' r='2.2'/></g></svg>`);
const POWDER_SRC = `data:image/svg+xml;charset=utf8,${POWDER_SVG}`;

/* è¨­å®šç²‰æœ«åœ–åˆ° img å…ƒç´  */
if(powderIconBottom) powderIconBottom.src = POWDER_SRC;
if(afkPowderImg) afkPowderImg.src = POWDER_SRC;

/* ----------------- ç­‰ç´šèˆ‡ UI ----------------- */
function calcLevel(){
  return levels.slice().reverse().find(l=>experience >= l.need) || levels[0];
}
function nextLevel(cur){
  const idx = levels.findIndex(l=>l.lvl===cur.lvl);
  return levels[idx+1] || null;
}
function updateLevelUI(){
  const cur = calcLevel(), nxt = nextLevel(cur);
  const pct = nxt ? Math.floor((experience - cur.need) / (nxt.need - cur.need) * 100) : 100;
  const levelBar = document.getElementById("level-bar");
  levelBar.style.width = pct + "%";
}

/* å¥—ç”¨é‡£ç«¿é¡è‰² */
function applyRodColor(name){
  const stroke = (rarityColors[name] && rarityColors[name].stroke) ? rarityColors[name].stroke : "#5d4037";
  const handle = (rarityColors[name] && rarityColors[name].handle) ? rarityColors[name].handle : "#5d4037";
  if(rodLineSVG) { rodLineSVG.setAttribute("stroke", stroke); rodLineSVG.style.stroke = stroke; }
  if(bobberSVG) { bobberSVG.setAttribute("fill", stroke); bobberSVG.setAttribute("stroke", "#222"); }
  if(rodBody) { rodBody.setAttribute("stroke", stroke); rodBody.style.stroke = stroke; }
  if(rodHandle) { rodHandle.setAttribute("fill", handle); rodHandle.style.fill = handle; }
}

/* æ›´æ–° UI æ•¸å€¼ */
function updateUI(){
  scoreD.textContent = score;
  coinD.textContent = coins;
  scoreD2.textContent = score;
  coinD2.textContent = coins;
  rodInfo.textContent = `ç•¶å‰é‡£ç«¿ï¼š${equippedRod}`;
  rodPreviewSmall.textContent = "ğŸ£";
  rodNameSmall.textContent = equippedRod;
  applyRodColor(equippedRod);
  updateLevelUI();
  powderCountSpan.textContent = powder;

  // å•†åº—é–å®šï¼ˆç¤ºæ„ï¼‰
  if(fishCaught >= 1) { shopLock.style.display = "none"; shopBtn.disabled = false; } else { shopLock.style.display = "inline"; shopBtn.disabled = false; }

  // æ›æ©Ÿè§£é–ï¼ˆç¤ºæ„ï¼šé‡£ 10 éš»é­šè§£é–ï¼‰
  if(fishCaught < 10){ afkBtn.disabled = true; } else { afkBtn.disabled = false; }
}

/* ----------------- æ©Ÿç‡ / é‡£é­š ----------------- */
/* å°‡åŸºç¤ rank æ©Ÿç‡ (D,C,B,A,S) æ ¹æ“šé‡£ç«¿ç­‰ç´š (rodLevels) åšå¾®èª¿
   æ¯ç­‰ç´šæœƒå¢åŠ ã€Œæ¯ç´š +1% (0.01)ã€å‚¾å‘é«˜éšçš„æ¬Šé‡ï¼ˆæŒ‰ç…§ rank index åŠ æ¬Šï¼‰ï¼Œ
   å† normalizeã€‚*/
function getRankWeightsForRod(rodName){
  const base = baseRankProbsByRod[rodName] || baseRankProbsByRod["æ™®é€šé‡£ç«¿"];
  const lvl = rodLevels[rodName] || 0;
  const ranks = ["D","C","B","A","S"];
  const extraPerLevel = lvl * 0.01;
  let arr = ranks.map((r,i) => {
    const posFactor = i / (ranks.length - 1); // 0..1
    return (base[r] || 0) + extraPerLevel * posFactor;
  });
  const s = arr.reduce((a,b)=>a+b,0);
  return ranks.reduce((acc,r,i)=>{ acc[r] = arr[i]/s; return acc; }, {});
}

/* éš¨æ©Ÿé¸é­šï¼šå…ˆå¾—åˆ° rank æ©Ÿç‡ï¼Œç„¶å¾Œåœ¨è©² rank ä¸­å¹³å‡åˆ†é…çµ¦è©² rank çš„æ‰€æœ‰é­š */
function getRandomFish(){
  const rankWeights = getRankWeightsForRod(equippedRod);
  // gather fish by rank
  const ranks = {};
  fishList.forEach(f => {
    ranks[f.rank] = ranks[f.rank] || [];
    ranks[f.rank].push(f);
  });
  // build per-fish weighted array
  const fishWeights = [];
  for(const rank in rankWeights){
    const list = ranks[rank] || [];
    if(list.length === 0) continue;
    const perFish = rankWeights[rank] / list.length;
    list.forEach(f => fishWeights.push({ fish: f, w: perFish }));
  }
  // normalize again just in case
  const total = fishWeights.reduce((a,b)=>a+b.w,0);
  let r = Math.random() * total;
  for(const item of fishWeights){
    r -= item.w;
    if(r <= 0) return item.fish;
  }
  // fallback
  return fishList[Math.floor(Math.random()*fishList.length)];
}

/* ------------ é‡£é­šå‹•ç•«/é¡¯ç¤º ------------- */
function setLineTo(y){
  const x1=520, y1=150, cx=540, cy=(150+y)/2 + 20, x2=560;
  if(rodLineSVG) rodLineSVG.setAttribute("d", `M${x1},${y1} Q${cx},${cy} ${x2},${y}`);
  if(bobberSVG) bobberSVG.setAttribute("cy", y);
}

function animateBobberSequence(downY=320, upY=190, downDur=500, upDur=600, cb){
  const start = parseFloat(bobberSVG.getAttribute("cy") || 190);
  let startTime = null;
  function downStep(ts){
    if(!startTime) startTime = ts;
    const p = Math.min(1,(ts-startTime)/downDur);
    const ease = p<0.5 ? 2*p*p : -1 + (4-2*p)*p;
    const y = start + (downY - start) * ease;
    setLineTo(y);
    if(p<1) requestAnimationFrame(downStep);
    else {
      startTime = null;
      const s = downY;
      const upStart = performance.now();
      function upStep(t2){
        const pp = Math.min(1,(t2-upStart)/upDur);
        const ease2 = pp<0.5 ? 2*pp*pp : -1 + (4-2*pp)*pp;
        const y2 = s + (upY - s) * ease2;
        setLineTo(y2);
        if(pp<1) requestAnimationFrame(upStep);
        else if(typeof cb === "function") cb();
      }
      requestAnimationFrame(upStep);
    }
  }
  requestAnimationFrame(downStep);
}

let isFishing = false;
function fish(isSilent){
  if(isFishing) return;
  isFishing = true;

  if(!isSilent){
    result.textContent = "æ­£åœ¨é‡£é­šï¼ï¼ï¼";
    fishIcon.textContent = "";
    fishLevel.textContent = "";
    bobberSVG.setAttribute("cy", 190);
  }

  animateBobberSequence(330, 190, 550, 600, ()=>{
    const f = getRandomFish();
    score += f.score;
    experience += 1;
    if(f.name !== "ç©ºæ°£"){ fishCaught++; localStorage.setItem("fishCaught", fishCaught); }
    const gain = f.coinMax>0 ? Math.floor(Math.random()*(f.coinMax - f.coinMin + 1)) + f.coinMin : 0;
    coins += gain;

    localStorage.setItem("score", score);
    localStorage.setItem("coins", coins);
    localStorage.setItem("experience", experience);

    // name badge with rank background (æ”¹ç‚ºèƒŒæ™¯è‰²)
    const badge = document.createElement("span");
    badge.className = "fish-name-badge " + (rankClass[f.rank] || "");
    badge.textContent = f.name;
    fishLevel.innerHTML = "";
    fishLevel.appendChild(badge);

    // icon pop animation
    fishIcon.textContent = f.icon;
    fishIcon.classList.remove("fish-pop");
    void fishIcon.offsetWidth;
    fishIcon.classList.add("fish-pop");
    fishIcon.style.transform = "scale(1.06)";
    setTimeout(()=> fishIcon.style.transform = "scale(1)", 420);

    result.textContent = `${f.name}ï¼ˆ+${f.score}åˆ†ï¼‰ ç²å¾—é‡‘å¹£ï¼š${gain}`;

    try{ document.getElementById("sound-fish").currentTime = 0; document.getElementById("sound-fish").play(); }catch(e){}

    updateUI();
    checkUnlocks();
    isFishing = false;
  });
}

/* ------------ AFKï¼ˆæ›æ©Ÿï¼‰é‚è¼¯ï¼šæ–°å¢ç²‰æœ«çå‹µï¼ˆç­‰ç´š >= 2ï¼‰ ------------- */
function calcAfkRewards(){
  const now = Date.now();
  const diffHours = Math.floor((now - lastAFKTime) / (1000*60*60));
  if(diffHours > 0){
    afkCount = Math.min(7, afkCount + diffHours);
    lastAFKTime += diffHours * 60*60*1000;
    localStorage.setItem("afkCount", afkCount);
    localStorage.setItem("lastAFKTime", lastAFKTime);
  }
}

let afkPending = null;
function toggleAFKResults(){
  if(fishCaught < 10){ alert("æ›æ©Ÿå°šæœªè§£é–ï¼šéœ€é‡£ 10 éš»é­šè§£é–æ›æ©ŸåŠŸèƒ½ã€‚"); return; }
  calcAfkRewards();
  if(afkResults.style.display === "block"){ afkResults.style.display = "none"; return; }
  afkFishContainer.innerHTML = "";
  if(afkCount <= 0){ afkFishContainer.textContent = "ç›®å‰æ²’æœ‰æ›æ©Ÿé­šï¼Œè«‹å…ˆç­‰å¾…æˆ–ä½¿ç”¨å¿«é€Ÿå·¡é‚ã€‚"; afkCoinD.textContent = "é‡‘å¹£ï¼š0"; afkPowderDisplay.style.display = "none"; afkClaimBtn.disabled = true; afkPending = null; afkResults.style.display = "block"; return; }

  const map = {}, totalCoins = {v:0};
  for(let i=0;i<afkCount;i++){
    const f = getRandomFish();
    if(!map[f.name]) map[f.name] = {count:0, fish:f, coins:0};
    map[f.name].count++;
    const c = f.coinMax>0 ? Math.floor(Math.random()*(f.coinMax - f.coinMin + 1)) + f.coinMin : 0;
    map[f.name].coins += c;
    totalCoins.v += c;
  }

  for(const k in map){
    const o = map[k];
    const wr = document.createElement("div");
    wr.style.display = "flex"; wr.style.alignItems = "center"; wr.style.gap = "10px"; wr.style.marginBottom = "6px";
    const fishDiv = document.createElement("div");
    fishDiv.className = "afk-fish"; fishDiv.textContent = o.fish.icon;
    const cnt = document.createElement("div"); cnt.className = "afk-count"; cnt.textContent = `Ã—${o.count}`;
    fishDiv.appendChild(cnt);
    const coinDiv = document.createElement("div"); coinDiv.style.fontWeight = "900"; coinDiv.textContent = `ğŸª™ ${o.coins}`;
    wr.appendChild(fishDiv); wr.appendChild(coinDiv);
    afkFishContainer.appendChild(wr);
  }

  // å¦‚æœç©å®¶ç­‰ç´š >= 2ï¼Œå‰‡é¡å¤–çµ¦äºˆç²‰æœ«ï¼ˆç°¡å–®è¦å‰‡ï¼šæ¯ 5 éš»æ›æ©Ÿé­šçµ¦ 1 ç²‰æœ«ï¼‰
  const lvl = calcLevel().lvl;
  let extraPowder = 0;
  if(lvl >= 2){
    extraPowder = Math.floor(afkCount / 5); // æ¯ 5 éš» 1 ç²‰æœ«ï¼Œå¯ä»¥èª¿æ•´
  }

  afkCoinD.textContent = `é‡‘å¹£ï¼š${totalCoins.v}`;
  if(extraPowder > 0){
    afkPowderCount.textContent = extraPowder;
    afkPowderDisplay.style.display = "flex";
  } else {
    afkPowderDisplay.style.display = "none";
  }

  afkClaimBtn.disabled = false;
  afkPending = { map: map, coins: totalCoins.v, powder: extraPowder };
  afkResults.style.display = "block";
}

function claimAFKRewards(){
  if(!afkPending || afkCount <= 0){ alert("æ²’æœ‰æ›æ©Ÿçå‹µå¯é ˜å–ï¼"); return; }
  for(const k in afkPending.map){
    const o = afkPending.map[k];
    score += o.fish.score * o.count;
  }
  coins += afkPending.coins;
  // é ˜å–ç²‰æœ«ï¼ˆè‹¥æœ‰ï¼‰
  if(afkPending.powder && afkPending.powder > 0){
    powder += afkPending.powder;
    localStorage.setItem("powder", powder);
    alert(`é ˜å–æ›æ©Ÿçå‹µæˆåŠŸï¼åŒæ™‚ç²å¾—ç²‰æœ«ï¼š${afkPending.powder}`);
  } else {
    alert("æ›æ©Ÿçå‹µé ˜å–æˆåŠŸï¼");
  }
  afkCount = 0;
  afkPending = null;
  localStorage.setItem("score", score);
  localStorage.setItem("coins", coins);
  localStorage.setItem("afkCount", afkCount);
  updateUI();
  afkResults.style.display = "none";
}

/* å¿«é€Ÿå·¡é‚ */
function quickPatrolClaim(){
  const today = new Date(Date.now() + 8*3600*1000).toISOString().slice(0,10);
  const lvl = calcLevel().lvl;
  const maxClaim = lvl >= 4 ? 2 : 1;
  if(lastQuickPatrolClaimDate !== today) quickPatrolClaimsToday = 0;
  if(quickPatrolClaimsToday >= maxClaim){ alert(`ä»Šæ—¥å¿«é€Ÿå·¡é‚å·²é”ä¸Šé™ï¼ˆ${maxClaim}æ¬¡ï¼‰`); return; }
  const scoreGain = 60;
  const coinsGain = 200;
  score += scoreGain; coins += coinsGain;
  quickPatrolClaimsToday++;
  lastQuickPatrolClaimDate = today;
  localStorage.setItem("lastQuickPatrolClaimDate", today);
  localStorage.setItem("quickPatrolClaimsToday", quickPatrolClaimsToday);
  localStorage.setItem("score", score);
  localStorage.setItem("coins", coins);
  alert(`å¿«é€Ÿå·¡é‚çå‹µï¼š+${scoreGain} åˆ†ï¼Œ+${coinsGain} é‡‘å¹£`);
  updateUI();
}

/* ----------------- å•†åº— / é‡£ç«¿ / ç²‰æœ« ----------------- */
function renderShop(){
  shop.innerHTML = '';
  const title = document.createElement("div"); title.style.fontWeight = "900"; title.style.marginBottom = "8px"; title.textContent = "å•†åº—ï¼ˆæ¯é€±å¯è³¼ä¸€æ¬¡ï¼‰";
  shop.appendChild(title);
  const list = ["ç²¾è‰¯é‡£ç«¿","ç¨€æœ‰é‡£ç«¿","å²è©©é‡£ç«¿","å‚³èªªé‡£ç«¿","ç²‰æœ«åŒ…"];
  list.forEach(name=>{
    const it = document.createElement("div"); it.className = "shop-item";
    const left = document.createElement("div");
    if(name === "ç²‰æœ«åŒ…"){
      // ç²‰æœ«åœ–ç‰‡ + èªªæ˜
      left.innerHTML = `<img class="powder-img" src="${POWDER_SRC}" alt="powder"> &nbsp; ç²‰æœ«åŒ…ï¼ˆ300 ğŸª™ â†’ +100 ç²‰æœ«ï¼‰`;
    } else {
      left.textContent = `${name}ï¼ˆ${rodPrices[name]} ğŸª™ï¼‰`;
    }
    const btn = document.createElement("button");
    if(name === "ç²‰æœ«åŒ…"){
      btn.className = "shop-btn buy"; btn.textContent = "è³¼è²·";
      btn.addEventListener("click", ()=> buyPowderPack());
    } else if(ownedRods.includes(name)){ btn.className = "shop-btn owned"; btn.textContent = "å·²æ“æœ‰"; btn.disabled = true; }
    else {
      btn.className = "shop-btn buy"; btn.textContent = "è³¼è²·";
      btn.addEventListener("click", ()=> buyRod(name));
    }
    it.appendChild(left); it.appendChild(btn); shop.appendChild(it);
  });
}

function toggleShop(){
  if(fishCaught < 1){ if(!confirm("å•†åº—å°šæœªå®Œå…¨è§£é–ï¼ˆéœ€é‡£åˆ°ä¸€éš»é­šï¼‰ã€‚ä»è¦æ‰“é–‹å—ï¼Ÿ")) return; }
  renderShop();
  shop.style.display = shop.style.display === "block" ? "none" : "block";
}

/* è³¼è²·ç²‰æœ«åŒ…ï¼ˆ300 coins -> +100 powderï¼‰ */
function buyPowderPack(){
  const cost = 300;
  const amount = 100;
  if(coins < cost){ alert("é‡‘å¹£ä¸è¶³ï¼"); return; }
  coins -= cost;
  powder += amount;
  localStorage.setItem("coins", coins);
  localStorage.setItem("powder", powder);
  alert(`è³¼è²·æˆåŠŸï¼š+${amount} ç²‰æœ«`);
  updateUI();
  renderShop();
}

/* è³¼è²·é‡£ç«¿ï¼ˆæ¯æŠŠæ¯é€±ä¸€æ¬¡ï¼‰ */
function buyRod(name){
  const now = new Date();
  const key = "buyDate_" + name;
  const todayKey = now.toISOString().slice(0,10);
  const bought = localStorage.getItem(key) || "";
  if(bought === todayKey){ alert("ä»Šå¤©å·²è³¼è²·éé€™æŠŠé‡£ç«¿ï¼ï¼ˆæ¯é€±é‡è£½æˆ–é™åˆ¶å¯æ“´ï¼‰"); return; }
  if(coins < rodPrices[name]){ alert("é‡‘å¹£ä¸è¶³ï¼"); return; }
  coins -= rodPrices[name];
  ownedRods.push(name);
  equippedRod = name;
  localStorage.setItem("coins", coins);
  localStorage.setItem("ownedRods", JSON.stringify(ownedRods));
  localStorage.setItem("rod", equippedRod);
  localStorage.setItem(key, todayKey);
  alert(`è³¼è²·æˆåŠŸï¼š${name}ï¼ˆå·²è‡ªå‹•è£å‚™ï¼‰`);
  updateUI();
  renderShop();
}

/* é‡£ç«¿ modal åˆ—è¡¨ï¼ˆå« previewï¼Œé¡¯ç¤ºæœªæ“æœ‰ä¹Ÿå¯é è¦½ï¼‰ */
function renderRodListModal(){
  rodListDiv.innerHTML = "";
  const modalPreview = document.getElementById("rod-modal-preview");
  modalPreview.style.display = "flex";
  const all = ["æ™®é€šé‡£ç«¿","ç²¾è‰¯é‡£ç«¿","ç¨€æœ‰é‡£ç«¿","å²è©©é‡£ç«¿","å‚³èªªé‡£ç«¿"];
  all.forEach(name=>{
    const row = document.createElement("div"); row.className = "rod-row";
    const left = document.createElement("div"); left.style.display="flex"; left.style.alignItems="center"; left.style.gap="8px";
    const preview = document.createElement("div"); preview.style.width="84px"; preview.style.height="36px"; preview.style.background="#fff"; preview.style.display="flex"; preview.style.alignItems="center"; preview.style.justifyContent="center"; preview.style.borderRadius="8px"; preview.textContent="ğŸ£";
    const lvl = rodLevels[name] || 0;
    const txt = document.createElement("div");
    txt.innerHTML = `<div style="font-weight:900">${name} ${ownedRods.includes(name) ? '' : '(æœªæ“æœ‰)'}</div><div style="font-size:12px;color:#666">ç­‰ç´š ${lvl} Â· åƒ¹æ ¼ ${rodPrices[name]||"-"}</div>`;
    left.appendChild(preview); left.appendChild(txt);
    const right = document.createElement("div"); right.style.display="flex"; right.style.gap="8px"; right.style.alignItems="center";
    if(ownedRods.includes(name)){
      const btn = document.createElement("button");
      if(equippedRod === name){ btn.textContent = "å·²è£å‚™"; btn.className = "modal-equip-btn disabled"; btn.disabled = true; }
      else {
        btn.textContent = "è£å‚™"; btn.className = "modal-equip-btn equip";
        btn.addEventListener("click", ()=> { equipRod(name); renderRodListModal(); renderPreview(name); });
      }
      right.appendChild(btn);
    } else {
      const buyBtn = document.createElement("button");
      buyBtn.className = "modal-equip-btn equip";
      buyBtn.textContent = "è³¼è²·";
      buyBtn.addEventListener("click", ()=> buyRod(name));
      right.appendChild(buyBtn);
    }

    // å‡ç´šæŒ‰éˆ•ï¼ˆåªå°å·²æ“æœ‰çš„æœ‰æ•ˆï¼‰
    const upgradeBtn = document.createElement("button");
    upgradeBtn.style.padding = "8px 10px"; upgradeBtn.style.borderRadius = "8px"; upgradeBtn.style.fontWeight = "800";
    const curLvl = rodLevels[name] || 0;
    const nextLvl = curLvl + 1;
    const powderCost = nextLvl * 100;
    const coinCost = nextLvl * 200;
    upgradeBtn.textContent = `å‡ç´š â†’ Lv.${nextLvl}ï¼ˆ${powderCost} ç²‰ + ${coinCost} ğŸª™ï¼‰`;
    if(!ownedRods.includes(name)) { upgradeBtn.disabled = true; upgradeBtn.style.background = "#ddd"; }
    else {
      upgradeBtn.style.background = "#FF9800";
      upgradeBtn.addEventListener("click", ()=> upgradeRod(name));
    }

    preview.addEventListener("click", ()=> renderPreview(name));

    right.appendChild(upgradeBtn);
    row.appendChild(left); row.appendChild(right);
    rodListDiv.appendChild(row);
  });
}

/* renderPreview: æŠŠé¸ä¸­é‡£ç«¿æ¸²æŸ“åˆ° #rod-preview-svg èˆ‡æ–‡å­— */
function renderPreview(name){
  const svgel = document.getElementById("rod-preview-svg");
  const modalPreview = document.getElementById("rod-modal-preview");
  modalPreview.style.display = "flex";
  while(svgel.firstChild) svgel.removeChild(svgel.firstChild);
  const ns = "http://www.w3.org/2000/svg";
  const handle = document.createElementNS(ns,"rect");
  handle.setAttribute("x", "20"); handle.setAttribute("y", "80"); handle.setAttribute("width", "80"); handle.setAttribute("height", "14"); handle.setAttribute("rx","8");
  handle.setAttribute("fill", rarityColors[name] ? rarityColors[name].handle : "#5d4037");
  const reel = document.createElementNS(ns,"circle");
  reel.setAttribute("cx","110"); reel.setAttribute("cy","87"); reel.setAttribute("r","12"); reel.setAttribute("fill","#9e9e9e"); reel.setAttribute("stroke","#616161");
  const body = document.createElementNS(ns,"path");
  body.setAttribute("d","M140,88 C240,70 360,54 520,30");
  body.setAttribute("stroke", rarityColors[name] ? rarityColors[name].stroke : "#2e7d32");
  body.setAttribute("stroke-width","6"); body.setAttribute("fill","none"); body.setAttribute("stroke-linecap","round");
  const line = document.createElementNS(ns,"path");
  line.setAttribute("d","M520,30 Q540,90 560,140"); line.setAttribute("stroke", rarityColors[name] ? rarityColors[name].stroke : "#2e7d32"); line.setAttribute("stroke-width","2"); line.setAttribute("fill","none");
  const bob = document.createElementNS(ns,"circle"); bob.setAttribute("cx","560"); bob.setAttribute("cy","140"); bob.setAttribute("r","8"); bob.setAttribute("fill", rarityColors[name] ? rarityColors[name].stroke : "#2e7d32");
  svgel.appendChild(handle); svgel.appendChild(reel); svgel.appendChild(body); svgel.appendChild(line); svgel.appendChild(bob);

  const lvl = rodLevels[name] || 0;
  document.getElementById("rod-preview-name").textContent = name + `ï¼ˆç­‰ç´š ${lvl}ï¼‰`;
  document.getElementById("rod-preview-desc").textContent = `é è¦½ï¼š${name}ï¼ˆåƒ¹æ ¼ ${rodPrices[name]||"â€”"}ï¼‰ - æŒæœ‰ï¼š${ownedRods.includes(name) ? 'æ˜¯' : 'å¦'}`;
}

/* å‡ç´šé‡£ç«¿ */
function upgradeRod(name){
  if(!ownedRods.includes(name)){ alert("å°šæœªå–å¾—æ­¤é‡£ç«¿ï¼Œç„¡æ³•å‡ç´šã€‚"); return; }
  const cur = rodLevels[name] || 0;
  const nextLvl = cur + 1;
  const powderCost = nextLvl * 100;
  const coinCost = nextLvl * 200;
  if(powder < powderCost){ alert(`ç²‰æœ«ä¸è¶³ï¼ˆéœ€ ${powderCost} ç²‰ï¼‰`); return; }
  if(coins < coinCost){ alert(`é‡‘å¹£ä¸è¶³ï¼ˆéœ€ ${coinCost} é‡‘å¹£ï¼‰`); return; }
  powder -= powderCost;
  coins -= coinCost;
  rodLevels[name] = nextLvl;
  localStorage.setItem("powder", powder);
  localStorage.setItem("coins", coins);
  localStorage.setItem("rodLevels", JSON.stringify(rodLevels));
  alert(`${name} å·²å‡ç´šåˆ° Lv.${rodLevels[name]}ï¼ˆæ¶ˆè€— ${powderCost} ç²‰ + ${coinCost} é‡‘å¹£ï¼‰`);
  updateUI();
  renderRodListModal();
  renderPreview(name);
}

/* è£å‚™é‡£ç«¿ */
function equipRod(name){
  if(!ownedRods.includes(name)){
    toggleShop();
    return;
  }
  equippedRod = name;
  localStorage.setItem("rod", equippedRod);
  updateUI();
  alert(`å·²è£å‚™ï¼š${name}`);
}

/* æª¢æŸ¥è§£é–ï¼ˆæç¤ºä¸€æ¬¡ï¼‰ */
function showUnlockNotice(msg){
  const n = document.getElementById("unlock-notice");
  n.textContent = msg; n.style.display = "block";
  setTimeout(()=>{ n.style.display = "none"; }, 1700);
}
function showLevelUpNotice(lvl){
  const n = document.getElementById("level-up-notice");
  n.textContent = `å‡ç´šï¼ ç­‰ç´š ${lvl}`;
  n.style.display = "block";
  setTimeout(()=>{ n.style.display = "none"; }, 1600);
}
function checkUnlocks(){
  if(fishCaught >= 1 && !shownUnlocks.shop){ shownUnlocks.shop = true; localStorage.setItem(UNLOCK_KEY, JSON.stringify(shownUnlocks)); showUnlockNotice("å•†åº—å·²è§£é–ï¼"); }
  if(fishCaught >= 10 && !shownUnlocks.afk){ shownUnlocks.afk = true; localStorage.setItem(UNLOCK_KEY, JSON.stringify(shownUnlocks)); showUnlockNotice("æ›æ©Ÿå·²è§£é–ï¼"); }
}

/* ç¶å®šäº‹ä»¶ */
document.getElementById("fish-btn").addEventListener("click", ()=> fish(false));
document.getElementById("rod-btn").addEventListener("click", ()=>{
  renderRodListModal();
  renderPreview(equippedRod);
  const modal = document.getElementById("rod-modal");
  modal.classList.add("show");
});
document.getElementById("rod-modal-close").addEventListener("click", ()=> { document.getElementById("rod-modal").classList.remove("show"); });
document.getElementById("afk-btn").addEventListener("click", ()=> toggleAFKResults());
document.getElementById("afk-claim-btn").addEventListener("click", ()=> claimAFKRewards());
document.getElementById("quick-patrol-claim-btn").addEventListener("click", ()=> quickPatrolClaim());
document.getElementById("afk-close-btn").addEventListener("click", ()=> { afkResults.style.display = "none"; });
document.getElementById("shop-btn").addEventListener("click", ()=> toggleShop());
openShopBottom.addEventListener("click", ()=> toggleShop());
document.getElementById("rod-preview-small").addEventListener("click", ()=> { renderRodListModal(); renderPreview(equippedRod); document.getElementById("rod-modal").classList.add("show"); });

/* åˆå§‹åŒ– */
function init(){
  // load rodLevels & powder to ensure UI sync
  rodLevels = JSON.parse(localStorage.getItem("rodLevels") || "null") || rodLevels;
  powder = +localStorage.getItem("powder") || powder;
  // set powder icons
  if(powderIconBottom) powderIconBottom.src = POWDER_SRC;
  if(afkPowderImg) afkPowderImg.src = POWDER_SRC;

  // æ¯åˆ†é˜æª¢æŸ¥æ›æ©Ÿç´¯ç©
  setInterval(()=>{ calcAfkRewards(); updateUI(); }, 60*1000);
  updateUI();
  applyRodColor(equippedRod);
  checkUnlocks();
}
init();

</script>
</body>
</html>
